# ğŸš¦ SimulaciÃ³n de TrÃ¡fico Paralelo

> **PrÃ¡ctica de Laboratorio #4 - ComputaciÃ³n Paralela**  
> Sistema de control de trÃ¡fico vehicular usando paralelismo basado en procesos e hilos en Python 3.13t

[![Python 3.13t](https://img.shields.io/badge/Python-3.13t-blue.svg)](https://www.python.org/)
[![Free-Threading](https://img.shields.io/badge/GIL-Disabled-green.svg)]()
[![Status](https://img.shields.io/badge/Status-Completed-success.svg)]()

---

## ğŸ“‹ Tabla de Contenidos

- [DescripciÃ³n](#-descripciÃ³n)
- [CaracterÃ­sticas](#-caracterÃ­sticas)
- [Requisitos](#-requisitos)
- [InstalaciÃ³n](#-instalaciÃ³n)
- [Uso](#-uso)
- [Arquitectura](#-arquitectura)
- [Datos Disponibles](#-datos-disponibles)
- [DocumentaciÃ³n](#-documentaciÃ³n)
- [Resultados](#-resultados)
- [Desarrollo](#-desarrollo)

---

## ğŸ¯ DescripciÃ³n

Sistema completo de simulaciÃ³n de trÃ¡fico vehicular en una intersecciÃ³n de 4 vÃ­as (Norte, Sur, Este, Oeste) que:

- âœ… Implementa **paralelismo basado en hilos** (threading)
- âœ… Implementa **paralelismo basado en procesos** (multiprocessing)
- âœ… Aprovecha **Python 3.13t con GIL deshabilitado**
- âœ… Controla semÃ¡foros con sistema de fases seguro
- âœ… Simula llegada y despacho de vehÃ­culos
- âœ… Recopila estadÃ­sticas en tiempo real
- âœ… Rastrea eventos y vehÃ­culos en trÃ¡nsito
- â³ GUI con Tkinter (en desarrollo)

---

## âœ¨ CaracterÃ­sticas

### **Backend Completo** âœ…

#### **Dos Motores de Paralelismo**
1. **Threading Engine** ğŸ§µ
   - Memoria compartida eficiente
   - SincronizaciÃ³n con `RLock` + `Condition`
   - Aprovecha mÃºltiples cores con GIL=0

2. **Multiprocessing Engine** ğŸ”„
   - Procesos independientes (1 por semÃ¡foro)
   - ComunicaciÃ³n vÃ­a `Queue` (IPC)
   - Siempre paralelo (independiente del GIL)

#### **Sistema de Control de TrÃ¡fico**
- ğŸš¦ 4 semÃ¡foros (uno por vÃ­a)
- ğŸ”„ Sistema de fases: NS_VERDE â†’ NS_AMARILLO â†’ EW_VERDE â†’ EW_AMARILLO
- âœ… PrevenciÃ³n de colisiones (vÃ­as perpendiculares nunca en verde)
- ğŸ“Š EstadÃ­sticas completas (vehÃ­culos, tiempos de espera)

#### **Datos Ricos para Frontend**
- ğŸš— Posiciones individuales de vehÃ­culos en colas
- ğŸ’¨ VehÃ­culos en trÃ¡nsito con progreso (0% â†’ 100%)
- ğŸ“‹ Log de eventos (llegadas, cruces, cambios de semÃ¡foro)
- â±ï¸ Timing de fases (countdown, barras de progreso)
- âš™ï¸ ConfiguraciÃ³n expuesta

---

## ğŸ“¦ Requisitos

### **Python 3.13t (Free-Threading)**

```bash
# Verificar versiÃ³n
py -3.13t --version
# Debe mostrar: Python 3.13.x
```

### **Sistema Operativo**
- âœ… Windows 11 (probado)
- âœ… Windows 10
- âœ… Linux
- âœ… macOS

### **Hardware**
- MÃ­nimo: 4 nÃºcleos lÃ³gicos
- Recomendado: 8+ nÃºcleos

---

## ğŸš€ InstalaciÃ³n

### **1. Clonar Repositorio**

```bash
git clone https://github.com/Abenavidese/traffic-simulation.git
cd traffic-simulation
```

### **2. Verificar Sistema**

```bash
py -3.13t -X gil=0 system_info.py
```

**Salida esperada:**
```
ğŸ Python:
  VersiÃ³n: 3.13.11
  Build: 3.13t (free-threading)

ğŸ”’ Global Interpreter Lock (GIL):
  Estado: DESHABILITADO âœ“
  Free-threading disponible: SÃ­

ğŸ’» Hardware:
  NÃºcleos (lÃ³gicos): 24
```

### **3. No se requieren dependencias adicionales**
El proyecto usa solo la biblioteca estÃ¡ndar de Python.

---

## ğŸ® Uso

### **EjecuciÃ³n BÃ¡sica**

#### **Threading (Recomendado con GIL=0)**
```bash
py -3.13t -X gil=0 -m backend.app.sim threading
```

#### **Multiprocessing**
```bash
py -3.13t -X gil=0 -m backend.app.sim multiprocessing
```

### **Con ParÃ¡metros Personalizados**

```bash
py -3.13t -X gil=0 -m backend.app.sim threading \
  --ciclos 10 \
  --verde 5 \
  --amarillo 2 \
  --intervalo 0.3
```

**Argumentos disponibles:**
- `--ciclos N` - Ciclos mÃ­nimos a ejecutar (default: 10)
- `--verde N` - DuraciÃ³n de luz verde en ticks (default: 5)
- `--amarillo N` - DuraciÃ³n de luz amarilla en ticks (default: 2)
- `--intervalo S` - Tiempo entre ticks en segundos (default: 0.3)

### **Salida de Ejemplo**

```
======================================================================
Tick: 5 | Ciclo: 0 | Fase: NS_AMARILLO
======================================================================

ğŸš¦ SemÃ¡foros:
  ğŸŸ¡ NORTE  - AMARILLO  | Cola:   1 vehÃ­culos
  ğŸŸ¡ SUR    - AMARILLO  | Cola:   1 vehÃ­culos
  ğŸ”´ ESTE   - ROJO      | Cola:   3 vehÃ­culos
  ğŸ”´ OESTE  - ROJO      | Cola:   2 vehÃ­culos

ğŸ“Š EstadÃ­sticas:
  Total vehÃ­culos cruzados: 6
  Tiempo espera promedio: 0.000s
  VehÃ­culos por vÃ­a:
    NORTE: 3
    SUR: 3

ğŸ’» Sistema:
  motor: Threading
  python_version: 3.13.11
  gil_enabled: False
```

### **Tests de DemostraciÃ³n**

#### **Test de Datos para Frontend**
```bash
py -3.13t -X gil=0 test_nuevos_datos.py
```

#### **Test de Eventos y TrÃ¡nsito**
```bash
py -3.13t -X gil=0 test_eventos_transito.py
```

---

## ğŸ—ï¸ Arquitectura

### **Estructura del Proyecto**

```
paralela-multi-hilos/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ core/              # LÃ³gica de dominio (NO conoce concurrencia)
â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”‚   â”œâ”€â”€ tipos.py         # Enums (Via, Color)
â”‚   â”‚   â”‚   â”œâ”€â”€ state.py         # TrafficState
â”‚   â”‚   â”‚   â””â”€â”€ stats.py         # EstadisticasTrafico
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â””â”€â”€ vehiculo.py      # Modelo de VehÃ­culo
â”‚   â”‚   â””â”€â”€ traffic/
â”‚   â”‚       â”œâ”€â”€ semaforo.py      # LÃ³gica de semÃ¡foro
â”‚   â”‚       â””â”€â”€ controlador.py   # Controlador de trÃ¡fico
â”‚   â”‚
â”‚   â”œâ”€â”€ runtime/          # Motores de concurrencia
â”‚   â”‚   â”œâ”€â”€ engines/
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py              # Interfaz base
â”‚   â”‚   â”‚   â”œâ”€â”€ threading_engine.py  # Motor de hilos
â”‚   â”‚   â”‚   â””â”€â”€ multiprocessing_engine.py  # Motor de procesos
â”‚   â”‚   â””â”€â”€ comms/
â”‚   â”‚       â””â”€â”€ messages.py          # Mensajes IPC
â”‚   â”‚
â”‚   â”œâ”€â”€ app/              # AplicaciÃ³n
â”‚   â”‚   â”œâ”€â”€ config.py        # ConfiguraciÃ³n
â”‚   â”‚   â””â”€â”€ sim.py           # Punto de entrada
â”‚   â”‚
â”‚   â””â”€â”€ tests/            # Tests unitarios
â”‚       â”œâ”€â”€ test_controlador.py
â”‚       â””â”€â”€ test_semaforo.py
â”‚
â”œâ”€â”€ frontend/             # GUI (en desarrollo)
â”‚   â”œâ”€â”€ FRONTEND_GUIDE.md    # GuÃ­a de implementaciÃ³n
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ app.py
â”‚       â”œâ”€â”€ views/
â”‚       â””â”€â”€ render/
â”‚
â”œâ”€â”€ system_info.py       # VerificaciÃ³n del sistema
â”œâ”€â”€ test_nuevos_datos.py # Test de datos
â”œâ”€â”€ test_eventos_transito.py  # Test de eventos
â”œâ”€â”€ README.MD            # Este archivo
â””â”€â”€ IMPLEMENTATION.md    # DocumentaciÃ³n de implementaciÃ³n
```

### **Principio de DiseÃ±o**

> **El dominio NO cambia cuando cambias de hilos a procesos**

- `core/` - LÃ³gica pura, sin imports de threading/multiprocessing
- `runtime/` - Motores intercambiables
- `app/` - ConfiguraciÃ³n y ejecuciÃ³n

---

## ğŸ“Š Datos Disponibles

### **TrafficState - Fuente Ãšnica de Datos**

El backend expone **TODO** a travÃ©s del objeto `TrafficState`:

```python
@dataclass
class TrafficState:
    # BÃ¡sico
    tick: int                          # NÃºmero de tick
    ciclo: int                         # Ciclos completados
    fase: str                          # Fase actual
    luces: Dict[str, str]              # Via â†’ Color
    colas: Dict[str, int]              # Via â†’ Cantidad
    
    # EstadÃ­sticas
    estadisticas: Dict[str, any]       # MÃ©tricas
    info_sistema: Dict[str, str]       # Info del motor
    
    # Para Animaciones ğŸ¨
    vehiculos_detalle: Dict[str, list]      # Posiciones en cola
    vehiculos_en_transito: Dict[str, list]  # Cruzando (0%-100%)
    eventos_tick: Dict[str, list]           # Log de eventos
    timing_fase: Dict[str, int]             # Countdown
    configuracion: Dict[str, any]           # ParÃ¡metros
```

### **Ejemplo de Acceso**

```python
from backend.runtime.engines.threading_engine import ThreadingEngine
from backend.app.config import ConfiguracionSimulacion

# Crear engine
config = ConfiguracionSimulacion()
engine = ThreadingEngine(config)
engine.start()

# Ejecutar tick
state = engine.step()

# Acceder a datos
print(f"Tick: {state.tick}")
print(f"Luces: {state.luces}")
print(f"VehÃ­culos en NORTE: {state.vehiculos_detalle['NORTE']}")
print(f"Eventos: {state.eventos_tick['eventos']}")
```

### **GuÃ­a Completa de Datos**

Para documentaciÃ³n detallada de todos los campos disponibles, ver:
- ğŸ“– [`frontend/FRONTEND_GUIDE.md`](frontend/FRONTEND_GUIDE.md) - GuÃ­a de implementaciÃ³n frontend

---

## ğŸ“š DocumentaciÃ³n

### **Documentos Principales**

| Documento | DescripciÃ³n |
|-----------|-------------|
| [`IMPLEMENTATION.md`](IMPLEMENTATION.md) | GuÃ­a de implementaciÃ³n completa |
| [`frontend/FRONTEND_GUIDE.md`](frontend/FRONTEND_GUIDE.md) | GuÃ­a de datos para frontend |

### **Documentos TÃ©cnicos**

Disponibles en `.gemini/antigravity/brain/[conversation-id]/`:
- `walkthrough.md` - Resumen de implementaciÃ³n
- `analisis_comparativo.md` - Threading vs Multiprocessing
- `analisis_datos_frontend.md` - AnÃ¡lisis de datos para GUI
- `resumen_mejoras_backend.md` - Resumen de mejoras
- `eventos_y_transito_completado.md` - Sistema de eventos

---

## ğŸ§ª Resultados

### **Threading Engine (GIL=0)**

```
âœ… Ciclos completados: 10
âœ… Ticks ejecutados: 140
âœ… VehÃ­culos cruzados: 336
â±ï¸ Tiempo total: 28.10s
ğŸš€ Rendimiento: 4.98 ticks/segundo
```

### **Multiprocessing Engine**

```
âœ… Ciclos completados: 10
âœ… Ticks ejecutados: 140
âœ… VehÃ­culos cruzados: 333
â±ï¸ Tiempo total: 28.34s
ğŸš€ Rendimiento: 4.94 ticks/segundo
```

### **ConclusiÃ³n**

Con **Python 3.13t y GIL deshabilitado**:
- âœ… Threading es ~0.8% mÃ¡s rÃ¡pido
- âœ… Ambos funcionan correctamente
- âœ… Sin colisiones detectadas
- âœ… Threading mÃ¡s simple de implementar

---

## ğŸ‘¨â€ğŸ’» Desarrollo

### **Estructura de Clases Core**

#### **`tipos.py`** - Enumeraciones
```python
class Via(Enum):
    NORTE, SUR, ESTE, OESTE

class Color(Enum):
    ROJO, AMARILLO, VERDE
```

#### **`vehiculo.py`** - Modelo de VehÃ­culo
```python
@dataclass
class Vehiculo:
    id: int
    tiempo_llegada: float
    tiempo_inicio_espera: Optional[float]
    tiempo_salida: Optional[float]
```

#### **`semaforo.py`** - SemÃ¡foro
```python
class Semaforo:
    def tick(self) -> List[Vehiculo]:
        """Despacha vehÃ­culos si estÃ¡ en VERDE"""
    
    def get_vehiculos_detalle(self) -> list:
        """Retorna lista detallada para frontend"""
```

#### **`controlador.py`** - Controlador
```python
class ControladorTrafico:
    def avanzar_tick(self) -> Dict[Via, Color]:
        """Avanza fase y retorna plan de colores"""
    
    def get_timing_fase(self) -> dict:
        """Info de timing para countdown"""
```

### **Tests Unitarios**

```bash
# Instalar pytest
pip install pytest

# Ejecutar tests
py -3.13t -m pytest backend/tests/ -v
```

### **Sistema de Eventos**

El sistema rastrea 3 tipos de eventos:

1. **Llegadas** ğŸš—â†’
```python
{"tipo": "vehiculo_llego", "via": "NORTE", "vehiculo_id": 15}
```

2. **Cruces** ğŸš—âœ“
```python
{"tipo": "vehiculo_despachado", "via": "SUR", "vehiculo_id": 12}
```

3. **Cambios de SemÃ¡foro** ğŸŸ¢ğŸŸ¡ğŸ”´
```python
{"tipo": "cambio_semaforo", "via": "ESTE", 
 "color_anterior": "VERDE", "color_nuevo": "AMARILLO"}
```

---

## ğŸ¯ CaracterÃ­sticas Implementadas

| CaracterÃ­stica | Estado | Notas |
|----------------|--------|-------|
| Core Domain | âœ… | Todas las entidades |
| Threading Engine | âœ… | Con sincronizaciÃ³n RLock |
| Multiprocessing Engine | âœ… | Con Queue IPC |
| Control de Fases | âœ… | Sin colisiones |
| EstadÃ­sticas | âœ… | Completas |
| Sistema de Eventos | âœ… | Log completo |
| VehÃ­culos en TrÃ¡nsito | âœ… | Con progreso |
| Timing de Fases | âœ… | Countdown |
| Tests Unitarios | âœ… | Core completos |
| Info del Sistema | âœ… | Python, GIL, CPU |
| GUI Tkinter | â³ | En desarrollo |
| Informe Final | â³ | Pendiente |

---

## ğŸ”§ ConfiguraciÃ³n

### **ParÃ¡metros Disponibles**

```python
# En backend/app/config.py
ConfiguracionSimulacion(
    # SemÃ¡foros
    duracion_verde=5,              # Ticks en verde
    duracion_amarillo=2,           # Ticks en amarillo
    capacidad_cruce_por_tick=2,    # VehÃ­culos/tick
    
    # SimulaciÃ³n
    probabilidad_llegada=0.6,      # 60% por tick
    intervalo_tick=0.3,            # 300ms entre ticks
    ciclos_minimos=10,             # MÃ­nimo a simular
    
    # Motor
    modo="threading",              # "threading" o "multiprocessing"
)
```

---

## ğŸ“ˆ ComparaciÃ³n de Rendimiento

| Aspecto | Threading | Multiprocessing |
|---------|-----------|-----------------|
| **Rendimiento** | 4.98 t/s | 4.94 t/s |
| **Complejidad** | Baja | Alta |
| **Memoria** | Compartida | Separada |
| **Escalabilidad** | Media* | Alta |
| **Debugging** | FÃ¡cil | DifÃ­cil |
| **Portabilidad** | Media** | Alta |

*Con GIL=0  
**Requiere Python 3.13t

---

##ğŸ¤ Contribuciones

Este es un proyecto acadÃ©mico de la **Universidad de Cuenca**.

**Autor:** ComputaciÃ³n Paralela - PrÃ¡ctica #4  
**Instructor:** Ing. Gabriel LeÃ³n Paredes, PhD.

---

## ğŸ“„ Licencia

Proyecto acadÃ©mico - Universidad de Cuenca

---

## ğŸš€ PrÃ³ximos Pasos

1. âœ… Backend completo
2. â³ Implementar GUI con Tkinter
3. â³ Ejecutar simulaciÃ³n completa (10+ ciclos)
4. â³ AnÃ¡lisis comparativo detallado
5. â³ Generar informe tÃ©cnico
6. â³ Documentar resultados

---

## ğŸ“ Soporte

Para preguntas o problemas:
1. Revisar [`IMPLEMENTATION.md`](IMPLEMENTATION.md)
2. Revisar [`frontend/FRONTEND_GUIDE.md`](frontend/FRONTEND_GUIDE.md)
3. Verificar con `system_info.py`
4. Abrir un issue en GitHub

---

**Hecho con â¤ï¸ y Python 3.13t (free-threading)**

**Repositorio:** [github.com/Abenavidese/traffic-simulation](https://github.com/Abenavidese/traffic-simulation)